<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <title>Synacor Challenge by psaris</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Synacor Challenge</h1>
        <h2>Solution to Synacor Challenge written in k4</h2>

        <section id="downloads">
          <a href="https://github.com/psaris/synacor-challenge/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/psaris/synacor-challenge/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/psaris/synacor-challenge" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1>
<a id="synacor-challenge" class="anchor" href="#synacor-challenge" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Synacor Challenge</h1>

<h2>
<a id="the-challenge" class="anchor" href="#the-challenge" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The Challenge</h2>

<p>Given a <a href="challenge.bin">binary file</a> and
<a href="arch-spec">architecture specification</a> implement a
<a href="vm.k">virtual machine</a> to execute the binary and solve the
<a href="https://challenge.synacor.com/">challenges</a> that lie within.</p>

<h2>
<a id="the-solution" class="anchor" href="#the-solution" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The Solution</h2>

<p>This solution was implemented in
<a href="https://en.wikipedia.org/wiki/K_(programming_language)">k4</a> (the
underlying language of the more popular/verbose
<a href="https://en.wikipedia.org/wiki/Q_(programming_language_from_Kx_Systems)">q</a>)</p>

<p>The solution can be run by starting the virtual machine with the
<a href="https://kx.com/software-download.php">q binary</a> and passing an
optional file listing the commands to run.  If no file is provided,
<a href="commands.txt">commands.txt</a> is used.</p>

<div class="highlight highlight-source-shell"><pre>$ q vm.k [commands.txt]</pre></div>

<p>To issue <code>k</code> (instead of <code>q</code>) commands to the interpreter, we must
type an initial backslash</p>

<pre lang="q"><code>q)\

</code></pre>

<h2>
<a id="the-design" class="anchor" href="#the-design" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The Design</h2>

<h3>
<a id="memory" class="anchor" href="#memory" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>memory</h3>

<p>The challenge defines three types of memory:</p>

<ol>
<li>memory with 15-bit address space storing 16-bit values</li>
<li>eight registers</li>
<li>an unbounded stack which holds individual 16-bit values</li>
</ol>

<p>This specification allows us to model memory as a single integer
vector where:</p>

<ul>
<li>the first 32768 addresses are reserved for opcodes loaded from the
<a href="challenge.bin">binary</a>
</li>
<li>the next eight addresses (32769-32776) are reserved for the
registers</li>
<li>and all remaining elements, dynamically appended or dropped, are
used for the stack</li>
</ul>

<p>This solution stores the vector of bytes in the variable <code>b</code>.</p>

<h3>
<a id="addresses" class="anchor" href="#addresses" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>addresses</h3>

<p>The opcodes loaded from the <a href="challenge.bin">binary</a> are 16-bit values
stored as little-endian pairs (low byte, high byte). Under normal
conditions, we would load the file with a single call to
<a href="http://code.kx.com/wiki/Reference/OneColon">1:</a>:</p>

<pre lang="k"><code>  *(1#"h";1#2)1:`challenge.bin
21 21 19 87 19 101 19 108 19 99 19 111 19 109 19 101 19 32 19 116 19 111 19 3..
</code></pre>

<p>But this assumes the 16-bit values are signed values that range from
-32,768 through 32,767.</p>

<p><code>K</code> does not have an unsigned integer data type. At first glance, this
does not seems to matter because the specification states that literal
values range from 0 - 32,767.  But the eight registers are referenced
with values between 32768 - 32775. We must therefore load the bytes as
32-bit integers. To do this, we reshape the byte vector into pairs of
bytes, pad each pair with 2 extra bytes <code>0x0000</code>, and convert the
resulting 8-byte vectors into a 32-bit integers.</p>

<pre lang="k"><code>  |(0x0/:0x0000,)'0N 2#|1:`challenge.bin
21 21 19 87 19 101 19 108 19 99 19 111 19 109 19 101 19 32 19 116 19 111 19 3..
</code></pre>

<p>The final step pads the vector to address 32,775 so the stack can
begin at address 32,776.</p>

<pre lang="k"><code>  32776#|(32776#0i),(0x0/:0x0000,)'0N 2#|1:`challenge.bin
21 21 19 87 19 101 19 108 19 99 19 111 19 109 19 101 19 32 19 116 19 111 19 3..
</code></pre>

<h3>
<a id="opcodes" class="anchor" href="#opcodes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>opcodes</h3>

<p>All operations are implemented to accept a single memory address as
input and return the next executable address as output.  For example,
the <code>jt</code> opcode (jump to address located in x+1 if the value in
address x is true, and x+2 otherwise) is defined as:</p>

<pre lang="k"><code>JT:{$[G x;G x+1;x+2]}
</code></pre>

<p>To map the opcodes (which range in value from 0 through 21) to
operators, we construct a vector of operator names. This
solution stores them in the variable <code>o</code>.</p>

<pre lang="k"><code>o:`HALT`SET`PUSH`POP`EQ`GT`JMP`JT`JF`ADD`MULT`MOD`AND`OR`NOT`RMEM`WMEM`CALL`RET`OUT`IN`NOOP
</code></pre>

<p>Indexing into <code>o</code> produces the correct operator name, which <code>k</code> allows
us to use in-place of the actual operator. <code>K</code> will perform the lookup
for us.</p>

<h3>
<a id="execution" class="anchor" href="#execution" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>execution</h3>

<p>We define the operator <code>E</code> to accept an address which is used to query
the opcode for the next operation.  The operator is obtained and
passed the next address.</p>

<pre lang="k"><code>E:{o[G x]x+1}
</code></pre>

<p>Forcing operators to accept (and return) an address allows us to execute
a single operation,</p>

<pre lang="k"><code>  E 1
2
</code></pre>

<p>a set number of operations by iterating with a numeric left operand,</p>

<pre lang="k"><code>  35 E/ 1
Welcome to the Synacor Challenge!
70
</code></pre>

<p>or a variable number of operations by iterating with a condition as
the left operand.</p>

<pre lang="k"><code>  (~0=) E/ 1
</code></pre>

<p>In this case, operations are executed until the address returned is 0
(which we have designed the <code>halt</code> operator to return). We can start
the iteration at address 1 and safely rely on 0 to terminate the
iteration because the opcode in the first address is defined as
<code>noop</code>.</p>

<h3>
<a id="debugging" class="anchor" href="#debugging" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>debugging</h3>

<p>It is often necessary to view the values stored in the eight registers
as well as those on the stack. Two
<a href="http://code.kx.com/wiki/Views">views</a> are defined to make this
easier: <code>REG</code> and <code>STACK</code>.</p>

<pre lang="k"><code>  REG
25975 25974 26006 0 101 0 0 25734i
  STACK
6080 16 6124 1 2826 32 3 6 101 0i
</code></pre>

<h2>
<a id="the-puzzles" class="anchor" href="#the-puzzles" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The Puzzles</h2>

<p>The challenge begins by performing a self-test to exercise each of the
operators.  Passing this stage is an accomplishment in and of itself.
But the challenge hasn't even begun.  I will, of course, leave that to
you.</p>

<p>You must discover (and submit) 8 codes to complete the challenge. The
first code can be found in the
<a href="arch-spec">architecture specification</a>.  The second code is displayed
after implementing opcodes 0, 19 and 21 (as suggested in the
specification). Successfully implementing the remaining opcodes
reveals the third code.</p>

<p>Five more codes are discovered by solving the remaining puzzles:</p>

<ul>
<li>the maze</li>
<li>the ruins</li>
<li>the teleporter</li>
<li>the vault</li>
<li>the mirror</li>
</ul>

<h2>
<a id="the-prize" class="anchor" href="#the-prize" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The Prize</h2>

<p>The challenge was designed to attract competent programmers.
Successfully completing the challenge may get you an interview at
Synacor.  For me, completing the challenge was prize enough. The
closing <a href="Screen%20Shot%202016-01-16%20at%209.37.19%20AM.png">screenshot</a> is an
awesome souvenir.</p>
      </section>
    </div>

    
  </body>
</html>
